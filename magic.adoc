= Magic Archetypes and Queries
Doc writer <bna@dips.no>
v1.0, 2014-08-17
:toc:
:lab-test-crp: openEHR-EHR-OBSERVATION.lab_test-crp.v1
:lab-test-full-blood: openEHR-EHR-OBSERVATION.lab_test-full_blood_count.v1
:lab-test-urea: openEHR-EHR-OBSERVATION.lab_test-urea_and_electrolytes.v1
:lab-test-glucose: openEHR-EHR-OBSERVATION.lab_test-blood_glucose.v1
:lab-test-liver: openEHR-EHR-OBSERVATION.lab_test-liver_function.v1
:lab-test-d-dimer: openEHR-EHR-OBSERVATION.lab_test-d_dimer.v1
:body-temp: openEHR-EHR-OBSERVATION.body_temperature.v1

{toc}


== Supported EMR variables

Hb :: {lab-test-full-blood}, defined by element HB
D-dimer :: {lab-test-d-dimer}
Trombocytter :: {lab-test-full-blood}, defined by element platelet count
ALAT :: {lab-test-liver}, defined by element alanine aminotransferase
Kreatinin :: {lab-test-urea}, defined by element creatinin
Glucose :: {lab-test-glucose}
Natrium :: {lab-test-urea}, defined by element *sodium*.
Kalium :: {lab-test-urea}, defined by element potassium.
Hvite blodceller/leukocytter :: {lab-test-full-blood}, defined by white cell count.
Senkning :: {lab-test-full-blood}, defined by erythorcyte sedimentation rate (ESR)
CRP :: {lab-test-crp}


== Patients
These are the demo patients used. Data is given on the form "born"/"NPR-id"/"EHR-id".

Kristin Ranestad :: 10.04.1980 / 2012902 / 9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2
Ann Karin Steen :: 07.04.1959 / 2012904 / 87f468e0-f4b6-4c4d-811d-ed271cced3b0
Erik Ã˜ie :: 16.11.1938 / 2012906 / 9bbfe019-0485-406f-a260-b96ba03ed69f

== Score

=== CHADSVAS

==== AQL
----

SELECT a/data[at0002]/events[at0003]/time as DateTime, a/data[at0002]/events[at0003]/data[at0001]/items[at0099]/value as Result FROM EHR e[ehr_id/value='9bbfe019-0485-406f-a260-b96ba03ed69f'] CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.chadsvas_score.v1] ORDER BY a/data[at0002]/events[at0003]/time DESC FETCH 1
----

==== Marand

----
SELECT
  a#data/Any_event/time as DateTime,
  a#data/Any_event/data/Total_score as Result
FROM EHR e[ehr_id/value='9bbfe019-0485-406f-a260-b96ba03ed69f']

CONTAINS OBSERVATION a#CHADSVAS_Score

ORDER BY a#data/Any_event/time DESC FETCH 1
----

=== BMI

==== AQL

----
SELECT a/data[at0001]/events[at0002]/time, a/data[at0001]/events[at0002]/data[at0003]/items[at0004]/value FROM EHR e[ehr_id/value='9bbfe019-0485-406f-a260-b96ba03ed69f'] CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.body_mass_index.v1] ORDER BY a/data[at0001]/events[at0002]/time DESC FETCH 1
----

==== Marand

----
SELECT
  a#data/Any_event/time,
  a#data/Any_event/data/Body_Mass_Index
FROM EHR e[ehr_id/value='9bbfe019-0485-406f-a260-b96ba03ed69f']

CONTAINS OBSERVATION a#Body_mass_index

ORDER BY a#data/Any_event/time DESC FETCH 1

----

== Laboratory

=== Trombocytter
==== AQL
----
SELECT a/data[at0001]/events[at0002]/time as DateTime, a/data[at0001]/events[at0002]/data[at0003]/items[at0078.12]/value as Result FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2'] CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.lab_test-full_blood_count.v1] WHERE ( (a/data[at0001]/events[at0002]/data[at0003]/items[at0078.12]/value/magnitude > 0 AND a/data[at0001]/events[at0002]/data[at0003]/items[at0078.12]/value/units='10*9/l')) ORDER BY a/data[at0001]/events[at0002]/time DESC FETCH 1
----

==== Marand
----
SELECT
  a#data/Any_event/time as DateTime,
  a#data/Any_event/data/Platelet_count as Result

FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']

CONTAINS OBSERVATION a#Full_blood_count
WHERE (
   (a#data/Any_event/data/Platelet_count/magnitude > 0 AND a#data/Any_event/data/Platelet_count/units='10*9/l'))
ORDER BY a#data/Any_event/time DESC FETCH 1
----

=== Leukocytter

==== AQL
----
SELECT a/data[at0001]/events[at0002]/time, a/data[at0001]/events[at0002]/data[at0003]/items[at0078.13]/value FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2'] CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.lab_test-full_blood_count.v1] WHERE ( (a/data[at0001]/events[at0002]/data[at0003]/items[at0078.13]/value/magnitude > 0 AND a/data[at0001]/events[at0002]/data[at0003]/items[at0078.13]/value/units='10*9/l')) ORDER BY a/data[at0001]/events[at0002]/time DESC FETCH 1
----

==== Marand
----
SELECT
  a#data/Any_event/time,
  a#data/Any_event/data/White_cell_count
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']

CONTAINS OBSERVATION a#Full_blood_count
WHERE (
   (a#data/Any_event/data/White_cell_count/magnitude > 0
  AND a#data/Any_event/data/White_cell_count/units='10*9/l'))
ORDER BY a#data/Any_event/time DESC FETCH 1
----

=== Senkning
==== AQL
----
SELECT a/data[at0001]/events[at0002]/time as DateTime, a/data[at0001]/events[at0002]/data[at0003]/items[at0078.11]/value as Result FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2'] CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.lab_test-full_blood_count.v1] where a/data[at0001]/events[at0002]/data[at0003]/items[at0078.11]/value/magnitude > 0 ORDER BY a/data[at0001]/events[at0002]/time DESC FETCH 1
----

==== Marand
----
SELECT
  a#data/Any_event/time as DateTime,
  a#data/Any_event/data/Erythrocyte_sedimentation_rate_ESR_ as Result
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']

CONTAINS OBSERVATION a#Full_blood_count

where
a#data/Any_event/data/Erythrocyte_sedimentation_rate_ESR_/magnitude > 0

ORDER BY a#data/Any_event/time DESC FETCH 1
----

=== Natrium / Sodium

==== AQL
----
SELECT a/data[at0001]/events[at0002]/time as DateTime, a/data[at0001]/events[at0002]/data[at0003]/items[at0078.5]/value as Result FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2'] CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.lab_test-urea_and_electrolytes.v1] WHERE ( (a/data[at0001]/events[at0002]/data[at0003]/items[at0078.5]/value/magnitude > 0 AND a/data[at0001]/events[at0002]/data[at0003]/items[at0078.5]/value/units='mmol/l')) ORDER BY a/data[at0001]/events[at0002]/time DESC FETCH 1
----

==== Marand
----
SELECT
  a#data/Any_event/time as DateTime,
  a#data/Any_event/data/Sodum as Result
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']

CONTAINS OBSERVATION a#Urea_and_electrolytes
WHERE (
   (a#data/Any_event/data/Sodum/magnitude > 0
  AND a#data/Any_event/data/Sodum/units='mmol/l'))
ORDER BY a#data/Any_event/time DESC FETCH 1
----

=== Kalium / Potassium

==== AQL
----
SELECT a/data[at0001]/events[at0002]/time as DateTime, a/data[at0001]/events[at0002]/data[at0003]/items[at0078.4]/value as Result FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2'] CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.lab_test-urea_and_electrolytes.v1] WHERE ( (a/data[at0001]/events[at0002]/data[at0003]/items[at0078.4]/value/magnitude > 0 AND a/data[at0001]/events[at0002]/data[at0003]/items[at0078.4]/value/units='mmol/l')) ORDER BY a/data[at0001]/events[at0002]/time DESC FETCH 1
----

==== Marand
----
SELECT
  a#data/Any_event/time as DateTime,
  a#data/Any_event/data/Potassium as Result
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']

CONTAINS OBSERVATION a#Urea_and_electrolytes
WHERE (
   (a#data/Any_event/data/Potassium/magnitude > 0
  AND a#data/Any_event/data/Potassium/units='mmol/l'))
ORDER BY a#data/Any_event/time DESC FETCH 1
----

=== Kreatinin

==== AQL
----
SELECT a/data[at0001]/events[at0002]/time as DateTime, a/data[at0001]/events[at0002]/data[at0003]/items[at0078.7]/value as Result FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2'] CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.lab_test-urea_and_electrolytes.v1] WHERE ( a/data[at0001]/events[at0002]/data[at0003]/items[at0078.7]/value/magnitude > 0 ) ORDER BY a/data[at0001]/events[at0002]/time DESC FETCH 1
----

==== Marand

-----
SELECT
  a#data/Any_event/time as DateTime,
  a#data/Any_event/data/Creatinine as Result
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']

CONTAINS OBSERVATION a#Urea_and_electrolytes
WHERE (
   a#data/Any_event/data/Creatinine/magnitude > 0
   )
ORDER BY a#data/Any_event/time DESC FETCH 1

-----


=== D-dimer

==== AQL

----
SELECT a/data[at0001]/events[at0002]/time as DateTime,
a/data[at0001]/events[at0002]/data[at0003]/items[at0078.1]/value as Result
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']
CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.lab_test-d_dimer.v1]
WHERE
(
  (
  a/data[at0001]/events[at0002]/data[at0003]/items[at0078.1]/value/magnitude > 0
    AND
  a/data[at0001]/events[at0002]/data[at0003]/items[at0078.1]/value/units='mg/l'
  )
)

ORDER BY a/data[at0001]/events[at0002]/time
FETCH 100
----

==== Marand

----
SELECT
  a#data/Any_event/time as DateTime,
  a#data/Any_event/data/Result as Result
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']

CONTAINS OBSERVATION a#D_Dimer
WHERE (
   (a#data/Any_event/data/Result/magnitude > 0
  AND a#data/Any_event/data/Result/units='mg/l'))
ORDER BY a#data/Any_event/time FETCH 100
----
=== Hb

==== AQL

----
SELECT a/data[at0001]/events[at0002]/time as DateTime, a/data[at0001]/events[at0002]/data[at0003]/items[at0078.4]/value as Result FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2'] CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.lab_test-full_blood_count.v1] WHERE ( (a/data[at0001]/events[at0002]/data[at0003]/items[at0078.4]/value/magnitude > 0 AND a/data[at0001]/events[at0002]/data[at0003]/items[at0078.4]/value/units='gm/l')) ORDER BY a/data[at0001]/events[at0002]/time DESC FETCH 1
----

==== Marand
----
SELECT
  a#data/Any_event/time as DateTime,
  a#data/Any_event/data/Haemoglobin as Result

FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']

CONTAINS OBSERVATION a#Full_blood_count
WHERE (
   (a#data/Any_event/data/Haemoglobin/magnitude > 0
  AND a#data/Any_event/data/Haemoglobin/units='gm/l'))
ORDER BY a#data/Any_event/time DESC FETCH 1
----


=== ALAT
ALAT is defined in archetype {lab-test-liver} int the field Alanine Aminitransferase.

==== AQL
----
SELECT a/data[at0001]/events[at0002]/time, a/data[at0001]/events[at0002]/data[at0003]/items[at0078.1]/value FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2'] CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.lab_test-liver_function.v1] WHERE ( (a/data[at0001]/events[at0002]/data[at0003]/items[at0078.1]/value/magnitude > 0 AND a/data[at0001]/events[at0002]/data[at0003]/items[at0078.1]/value/units='U/l')) ORDER BY a/data[at0001]/events[at0002]/time DESC FETCH 1
----

==== Marand
----
SELECT
  a#data/Any_event/time,
  a#data/Any_event/data/Alanine_aminotransferase_ALT_
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']

CONTAINS OBSERVATION a#Liver_function_tests
WHERE (
   (a#data/Any_event/data/Alanine_aminotransferase_ALT_/magnitude > 0
  AND a#data/Any_event/data/Alanine_aminotransferase_ALT_/units='U/l'))
ORDER BY a#data/Any_event/time DESC FETCH 1
----


=== CRP
CRP is saved in the archetype {lab-test-crp}

==== AQL
----
SELECT
  a/data[at0001]/events[at0002]/time as DateTime,
  a/data[at0001]/events[at0002]/data[at0003]/items[at0078.1]/value as Result
FROM EHR e[ehr_id/value='298206f3-0246-4ce2-b7eb-f61f10ccc0ea']
CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.lab_test-crp.v1]
ORDER BY a/data[at0001]/events[at0002]/time
  FETCH 1
----
==== Marand
----
SELECT
  a#data/Any_event/time as DateTime,
  a#data/Any_event/data/Result as Result
FROM EHR e[ehr_id/value='298206f3-0246-4ce2-b7eb-f61f10ccc0ea']

CONTAINS OBSERVATION a#CRP

ORDER BY a#data/Any_event/time FETCH 1
----

=== Glucose
Glucose is defined in archetype {lab-test-glucose}.

==== AQL
----
SELECT
  a/data[at0001]/events[at0002]/time as DateTime,
  a/data[at0001]/events[at0002]/data[at0003]/items[at0078.2]/value as Result
FROM EHR e[ehr_id/value='298206f3-0246-4ce2-b7eb-f61f10ccc0ea']
CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.lab_test-blood_glucose.v1]
WHERE (
  (
    a/data[at0001]/events[at0002]/data[at0003]/items[at0078.2]/value/magnitude > 0
    AND
    a/data[at0001]/events[at0002]/data[at0003]/items[at0078.2]/value/units='mmol/l')
  )
ORDER BY a/data[at0001]/events[at0002]/time DESC
FETCH 1
----

==== Marand

----
SELECT
 a#data/Any_event/time,
 a#data/Any_event/data/Blood_glucose
FROM EHR e[ehr_id/value='298206f3-0246-4ce2-b7eb-f61f10ccc0ea']

CONTAINS OBSERVATION a#Blood_glucose
WHERE
(
  (
  a#data/Any_event/data/Blood_glucose/magnitude > 0
  AND
  a#data/Any_event/data/Blood_glucose/units='mmol/l'
  )
)
ORDER BY a#data/Any_event/time DESC FETCH 1
----

== Observations

=== Bodytemperature
Bodytemperature is defined in archetype *{body-temp}*
----
SELECT a/data[at0002]/events[at0003]/time as DateTime, a/data[at0002]/events[at0003]/data[at0001]/items[at0004]/value as Result
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']
CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.body_temperature.v1]
ORDER BY a/data[at0002]/events[at0003]/time DESC
FETCH 1
----

----
SELECT
  a#data/Any_event/time as DateTime,
  a#data/Any_event/data/Temperature as Result
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']

CONTAINS OBSERVATION a#Body_temperature

ORDER BY a#data/Any_event/time DESC FETCH 1
----

=== Bodyweight

AQL

----
SELECT
a/data[at0002]/events[at0003]/time as Result , a/data[at0002]/events[at0003]/data[at0001]/items[at0004]/value as Result
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']
CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.body_weight.v1]
ORDER BY a/data[at0002]/events[at0003]/time DESC FETCH 1
----

Marand

----
SELECT
  a#data/Any_event/time as Result ,
  a#data/Any_event/data/Weight as Result
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']
CONTAINS OBSERVATION a#Body_weight
ORDER BY a#data/Any_event/time DESC FETCH 1
----

=== Height and Length

----
SELECT
 a/data[at0001]/events[at0002]/time as Result ,
 a/data[at0001]/events[at0002]/data[at0003]/items[at0004]/value as Result
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']
CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.height.v1]
ORDER BY a/data[at0001]/events[at0002]/time DESC
FETCH 1
----

----
SELECT
  a#data/Any_event/time as Result ,
  a#data/Any_event/data/Height;Length as Result
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']

CONTAINS OBSERVATION a#Height;Length

ORDER BY a#data/Any_event/time DESC FETCH 1
----

=== Blood Pressure

----
SELECT
  a/data[at0001]/events[at0006]/time as DateTime,
  a/data[at0001]/events[at0006]/data[at0003]/items[at0004]/value as Systolic,
  a/data[at0001]/events[at0006]/data[at0003]/items[at0005]/value as Diastolic

FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']

CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.blood_pressure.v1]
ORDER BY a/data[at0001]/events[at0006]/time DESC
FETCH 1
----

----
SELECT
  a#data/any_event/time as DateTime,
  a#data/any_event/data/Systolic as Systolic,
  a#data/any_event/data/Diastolic as Diastolic
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']

CONTAINS OBSERVATION a#Blood_Pressure

ORDER BY a#data/any_event/time DESC FETCH 1
----


=== Pulse

Pulse is defined in archetype ECG,*openEHR-EHR-OBSERVATION.ecg.v1*.

==== AQL
----
SELECT
a/data[at0001]/events[at0002]/time,
a/data[at0001]/events[at0002]/data[at0005]/items[at0006]/items[at0013]/value
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']
CONTAINS OBSERVATION a[openEHR-EHR-OBSERVATION.ecg.v1]
ORDER BY a/data[at0001]/events[at0002]/time DESC
FETCH 1
----

==== Marand

----
SELECT
  a#data/Any_event/time,
  a#data/Any_event/data/Global_ECG_Parameters/RR_Rate
FROM EHR e[ehr_id/value='9ad8ecbf-9f4b-4af7-a5ba-a5e9225af1a2']

CONTAINS OBSERVATION a#ECG_recording

ORDER BY a#data/Any_event/time DESC FETCH 1
----
